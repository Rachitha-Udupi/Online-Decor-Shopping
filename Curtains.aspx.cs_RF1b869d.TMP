using System;
using System.Data;
using System.Configuration;
using System.Collections;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Web.UI.HtmlControls;
using System.Data.SqlClient;
using System.Windows.Forms;
//using System.Web.UI.WebControls.Label;


public partial class curtain : System.Web.UI.Page
{
    connect c;
    SqlDataAdapter adp = new SqlDataAdapter();
   // DataSet ds;
    DataTable dt = new DataTable();
    DataTable dt1 = new DataTable();
    DataTable dt2 = new DataTable();
    //DataTable dt3 = new DataTable();
    //DataTable dt4 = new DataTable();
    //DataTable dt5 = new DataTable();
    //DataTable dt6 = new DataTable();
    //DataTable dt7 = new DataTable();
    //DataTable dt8 = new DataTable();
    //DataTable orgdt = new DataTable();

    //string desc = ((System.Web.UI.WebControls.Label)e.Item.FindControl("Label2")).Text;
   
    protected void Page_Load(object sender, EventArgs e)
    {
       
      //Session["cat"]="Curtains";
       // c.cmd.CommandText = "select * from item where (category= '" + Session["cat"].ToString() + "')";
        //adp.SelectCommand = c.cmd;
        //c.cmd.ExecuteNonQuery();



    }

    protected void Button1_Click(object sender, EventArgs e)
    {
       

        try
        {
            if (Session["cust_id"] == null)
            {
                Page.ClientScript.RegisterStartupScript(this.GetType(), "msgbox", "<script> message('Please login first')</script>");
                Response.Redirect("~/clogin.aspx");
            }
            else
            {
                try
                {
                    if (Session["cust_id"] != null)
                        if (!Page.IsPostBack)
                        {
                           c = new connect();
                            c.cmd.CommandText = "select item_id from item";
                            adp.SelectCommand = c.cmd;
                            dt.Clear();
                            adp.Fill(dt);
                           
                            //int count;
                            //c.cmd.CommandText = "select count(*) from cart";
                            //count = Convert.ToInt16(c.cmd.ExecuteScalar()) + 1;
                            //Label lbl = DataList1.Items[i].FindControl("label3") as Label;
                            // string labeltext = lbl.Text;
                            //    Label lbl1 = DataList1.Items[i].FindControl("label1") as Label;
                            //string labeltext1 = lbl1.Text;
                            //Session["item_id"] = CType(DataList1.Controls(0).FindControl("Label3"), System.Web.UI.WebControls.Label).Text;
                            //Session["price"] = CType(DataList1.Controls(0).FindControl("Label1"), System.Web.UI.WebControls.Label).Text;
                            //c.cmd.CommandText = "insert into cart values(@cart_id,@item_id,@cust_id,@qty,@price)";
                            //c.cmd.Parameters.Clear();
                            //c.cmd.Parameters.Add("@cart_id", SqlDbType.Int).Value = count;
                            //c.cmd.Parameters.Add("@item_id", SqlDbType.Int).Value = Session["item_id"];
                            //c.cmd.Parameters.Add("@cust_id", SqlDbType.NVarChar).Value = Session["cust_id"];
                            //c.cmd.Parameters.Add("@price", SqlDbType.Int).Value = Session["price"];


                            //c.cmd.CommandText = "insert into cart(cart_id,item_id,cust_id,qty,price values('" + cart_id + "','" + Session["item_id"].ToString() + "','" + Session["cust_id"].ToString() + "','" + "'," + 1 + "," + Convert.ToInt64(s.Attributes["Label1"]) + ")";
                            //c.cmd.ExecuteNonQuery();
                            Page.ClientScript.RegisterStartupScript(this.GetType(), "msgbox", "<script> message('Item Successfully Added to Cart')</script>");
                            c.cmd.CommandText = "SELECT * FROM cart WHERE (cust_id = '" + Session["cust_id"].ToString() + "')";
                            adp.SelectCommand = c.cmd;
                            dt2.Clear();
                            adp.Fill(dt2);
                        }
                }
                catch (NullReferenceException)
                {
                    Page.ClientScript.RegisterStartupScript(this.GetType(), "msgbox", "<script> alert('Error Occured') </script>");
                }
                catch (Exception)
                {
                    throw;
                }
            }

        }

        catch (NullReferenceException)
        {
            Page.ClientScript.RegisterStartupScript(this.GetType(), "msgbox", "<script> message('You must login first')</script>");
            Response.Redirect("~/clogin.aspx");
            //Session["link"] = "item.aspx";
            //Response.AddHeader("REFRESH", "3;URL=clogin.aspx?val=login");
        }
        catch (Exception)
        {
            throw;
        }
        }

    private object CType(object p, System.Web.UI.WebControls.Label label)
    {
        throw new Exception("The method or operation is not implemented.");
    }
           

        
    

    protected void DataList1_ItemCommand(object source, DataListCommandEventArgs e)
    {
        //if (e.CommandName == "addtocart")
        //{
        //   Response.Redirect("cart.aspx?id=" + e.CommandArgument.ToString());

        //}
        //else if (e.CommandName == "viewdetail")
        //{
        //    Response.Redirect("~/viewdetail.aspx?id=" + e.CommandArgument.ToString());
        //}
        if (e.CommandName== "viewdetail")
        {
            Response.Redirect("~/viewdetail.aspx?id=" + e.CommandArgument.ToString());
        }

        else if (e.CommandName == "addtocart")
        {

            string i = ((System.Web.UI.WebControls.Label)e.Item.FindControl("Label3")).Text;
            string p = ((System.Web.UI.WebControls.Label)e.Item.FindControl("Label1")).Text;
            
            string n = ((System.Web.UI.WebControls.Label)e.Item.FindControl("Label4")).Text;
            string img = ((System.Web.UI.WebControls.Image)e.Item.FindControl("Image1")).ImageUrl;
            string q = ((System.Web.UI.WebControls.TextBox )e.Item.FindControl("TextBox1")).Text;
            connect c = new connect();
            int count;
          //  c.cmd.CommandText = "select count(*) from cart";
           // count = Convert.ToInt16(c.cmd.ExecuteScalar()) + 1;
            c.cmd.CommandText = "select count(item_id)from cart where cust_id='"+Session [cust_id].ToString ()+"'";
            count = Convert.ToInt16(c.cmd.ExecuteScalar());
            if (count > 1)
            {
                MessageBox.Show("already added");
            }
            else
            {

                c.cmd.CommandText = "insert into cart values(@item_id,@cust_id,@item_name,@price,@image,@qty)";
                c.cmd.Parameters.Clear();
                //   c.cmd.Parameters.Add("@cart_id", SqlDbType.Int).Value = count;
                c.cmd.Parameters.Add("@item_id", SqlDbType.Int).Value = i;
                c.cmd.Parameters.Add("@cust_id", SqlDbType.NVarChar).Value = Session["cust_id"];
                c.cmd.Parameters.Add("@item_name", SqlDbType.NVarChar).Value = n;
                c.cmd.Parameters.Add("@price", SqlDbType.BigInt).Value = p;
                c.cmd.Parameters.Add("@image", SqlDbType.NVarChar).Value = img;
                c.cmd.Parameters.Add("@qty", SqlDbType.Int).Value = q;




                c.cmd.ExecuteNonQuery();
                MessageBox.Show("Inserted");
                Response.Redirect("cart.aspx?id=" + e.CommandArgument.ToString());

            }
            //Class1.update_reg("add_reg", i, p, nm);
            //DataList1.EditItemIndex = -1;
            //Binddata();
        }
    }

   
}